<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body { background: #f6f8fb; }
    .card-soft { border: 0; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .small-muted { color:#6c757d; font-size: .92rem; }
    .table thead th { white-space: nowrap; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" th:href="@{/admin/dashboard}">ðŸ›  Admin Panel</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-end" id="nav">
      <ul class="navbar-nav me-3">
        <li class="nav-item"><a class="nav-link" th:href="@{/admin/dashboard}">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" th:href="@{/admin/orders}">Orders</a></li>
        <li class="nav-item"><a class="nav-link" th:href="@{/admin/riders}">Riders</a></li>
        <li class="nav-item"><a class="nav-link" th:href="@{/admin/users}">Users</a></li>
      </ul>

      <form th:action="@{/logout}" method="post" class="d-flex">
        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button class="btn btn-outline-light btn-sm">Logout</button>
      </form>
    </div>
  </div>
</nav>

<div class="container py-4">

  <!-- stats row -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card card-soft p-3">
        <div class="small-muted">Total Orders</div>
        <div class="fs-4 fw-bold" th:text="${stats != null ? stats.totalOrders : 0}">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-soft p-3">
        <div class="small-muted">Pending</div>
        <div class="fs-4 fw-bold" th:text="${stats != null ? stats.pending : 0}">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-soft p-3">
        <div class="small-muted">In Transit</div>
        <div class="fs-4 fw-bold" th:text="${stats != null ? stats.inTransit : 0}">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-soft p-3">
        <div class="small-muted">Delivered</div>
        <div class="fs-4 fw-bold" th:text="${stats != null ? stats.delivered : 0}">0</div>
      </div>
    </div>
  </div>

  <div th:if="${successMsg}" class="alert alert-success alert-dismissible fade show" role="alert">
    <span th:text="${successMsg}">Success</span>
    <button class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div class="row g-3">
    <!-- Orders table -->
    <div class="col-lg-8">
      <div class="card card-soft">
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-2">
            <div>
              <h5 class="mb-0">ðŸ“¦ Recent Orders</h5>
              <div class="small-muted">Manage orders & assignments</div>
            </div>

            <div class="d-flex gap-2">
              <input id="adminSearch" class="form-control form-control-sm" style="min-width:260px"
                     placeholder="Search order id / pickup / drop / status">
              <select id="adminStatus" class="form-select form-select-sm" style="min-width:160px">
                <option value="">All Status</option>
                <option value="PENDING">PENDING</option>
                <option value="ASSIGNED">ASSIGNED</option>
                <option value="IN_TRANSIT">IN_TRANSIT</option>
                <option value="DELIVERED">DELIVERED</option>
                <option value="CANCELLED">CANCELLED</option>
              </select>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle" id="adminOrdersTable">
              <thead class="table-light">
              <tr>
                <th>Order ID</th>
                <th>Type</th>
                <th>Pickup</th>
                <th>Drop</th>
                <th>Status</th>
                <th>Assigned Rider</th>
                <th class="text-end">Action</th>
              </tr>
              </thead>

              <tbody>
              <tr th:if="${orders == null || #lists.isEmpty(orders)}">
                <td colspan="7" class="text-center py-4">No orders found.</td>
              </tr>

              <tr th:each="o : ${orders}"
                  th:attr="data-status=${o.status}">
                <td class="fw-bold" th:text="${o.orderId}">#1021</td>
                <td><span class="badge text-bg-info" th:text="${o.type}">INSTANT</span></td>
                <td th:text="${o.pickup}">Dhanmondi</td>
                <td th:text="${o.drop}">Mirpur</td>

                <td>
                  <span class="badge"
                        th:classappend="${o.status=='PENDING'?' text-bg-warning':''}
                                        + ${o.status=='ASSIGNED'?' text-bg-primary':''}
                                        + ${o.status=='IN_TRANSIT'?' text-bg-info':''}
                                        + ${o.status=='DELIVERED'?' text-bg-success':''}
                                        + ${o.status=='CANCELLED'?' text-bg-danger':''}"
                        th:text="${o.status}">PENDING</span>
                </td>

                <td th:text="${o.assignedRiderName != null ? o.assignedRiderName : 'â€”'}">â€”</td>

                <td class="text-end">
                  <button class="btn btn-sm btn-outline-primary"
                          data-bs-toggle="modal"
                          data-bs-target="#assignModal"
                          th:attr="data-order=${o.orderId},data-id=${o.pk},data-type=${o.type}">
                    Assign
                  </button>

                  <form th:action="@{'/admin/orders/' + ${o.pk} + '/cancel'}"
                        method="post" style="display:inline;">
                    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button class="btn btn-sm btn-outline-danger">Cancel</button>
                  </form>
                </td>
              </tr>
              </tbody>

            </table>
          </div>

        </div>
      </div>
    </div>

    <!-- Riders quick list -->
    <div class="col-lg-4">
      <div class="card card-soft">
        <div class="card-body">
          <h5 class="mb-0">ðŸš´ Riders</h5>
          <div class="small-muted mb-3">Active riders overview</div>

          <div th:if="${riders == null || #lists.isEmpty(riders)}" class="text-center small-muted py-3">
            No riders found.
          </div>

          <div class="list-group" th:if="${riders != null && !#lists.isEmpty(riders)}">
            <div class="list-group-item d-flex justify-content-between align-items-center"
                 th:each="r : ${riders}">
              <div>
                <div class="fw-semibold" th:text="${r.name}">Rider Name</div>
                <div class="small-muted" th:text="${r.phone}">01XXXXXXXXX</div>
              </div>
              <span class="badge text-bg-success" th:text="${r.status}">ACTIVE</span>
            </div>
          </div>

          <a class="btn btn-sm btn-dark mt-3 w-100" th:href="@{/admin/riders}">Manage Riders</a>
        </div>
      </div>
    </div>

  </div>

</div>

<!-- Assign Modal -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:14px;">
      <div class="modal-header">
        <h5 class="modal-title">Assign Rider</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form th:action="@{/admin/orders/assign}" method="post">
        <div class="modal-body">
          <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

          <div class="mb-2"><b>Order:</b> <span id="aOrder">-</span></div>
          <input type="hidden" name="orderPk" id="aPk"/>
          <input type="hidden" name="orderType" id="aType"/>

          <label class="form-label mt-3">Select Rider</label>
          <select class="form-select" name="riderId" required>
            <option value="">Choose rider</option>
            <option th:each="r : ${riders}" th:value="${r.id}" th:text="${r.name}">Rider</option>
          </select>

          <div class="small-muted mt-2">Assigning will mark order as ASSIGNED.</div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Close</button>
          <button class="btn btn-primary" type="submit">Assign</button>
        </div>
      </form>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Search + status filter for orders table
  const adminSearch = document.getElementById('adminSearch');
  const adminStatus = document.getElementById('adminStatus');
  const adminTable = document.getElementById('adminOrdersTable');
  const adminRows = () => Array.from(adminTable.querySelectorAll('tbody tr')).filter(r => r.querySelector('td'));

  function adminApplyFilters() {
    const q = (adminSearch.value || '').toLowerCase();
    const st = adminStatus.value;

    adminRows().forEach(r => {
      const text = r.innerText.toLowerCase();
      const rowSt = r.getAttribute('data-status') || '';
      const okQ = !q || text.includes(q);
      const okS = !st || rowSt === st;
      r.style.display = (okQ && okS) ? '' : 'none';
    });
  }

  adminSearch?.addEventListener('input', adminApplyFilters);
  adminStatus?.addEventListener('change', adminApplyFilters);

  // Assign modal data
  const assignModal = document.getElementById('assignModal');
  assignModal?.addEventListener('show.bs.modal', (event) => {
    const btn = event.relatedTarget;
    document.getElementById('aOrder').textContent = btn.getAttribute('data-order') || '-';
    document.getElementById('aPk').value = btn.getAttribute('data-id') || '';
    document.getElementById('aType').value = btn.getAttribute('data-type') || '';
  });
</script>

</body>
</html>
