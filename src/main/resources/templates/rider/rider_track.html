<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rider Live Tracking</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body { background:#f6f8fb; }
    .card-soft { border:0; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.07); }
    #map { height: 520px; border-radius: 14px; }
    .small-muted { color:#6c757d; font-size:.92rem; }
    code { background:#f1f3f5; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" th:href="@{/rider/dashboard}">üö¥ Rider Panel</a>
    <div class="ms-auto">
      <span class="badge text-bg-light text-dark">
        Order: <span th:text="${orderId}">123</span>
      </span>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card card-soft">
        <div class="card-body">
          <h5 class="mb-1">üìç Live Location (Rider)</h5>
          <div class="small-muted mb-3">
            Start ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡ßã‡¶®‡ßá‡¶∞ GPS ‡¶•‡ßá‡¶ï‡ßá location ‡¶®‡¶ø‡ßü‡ßá server ‡¶è ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç map ‡¶è ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá‡•§
          </div>

          <div id="map"></div>

          <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
            <button class="btn btn-success" id="btnStart">Start Tracking</button>
            <button class="btn btn-outline-danger" id="btnStop" disabled>Stop</button>
            <span class="small-muted">Update interval: <b>~2‚Äì5 sec</b></span>
          </div>

          <div class="mt-3">
            <div class="alert alert-warning mb-0">
              ‚ö†Ô∏è Geolocation ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶≤‡ßá ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£‡¶§ <b>HTTPS</b> ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ (localhost ‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá) ‡¶è‡¶¨‡¶Ç location permission allow ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card card-soft">
        <div class="card-body">
          <h6 class="mb-2">‚ÑπÔ∏è Status</h6>

          <div class="mb-2"><b>Latitude:</b> <span id="lat">‚Äî</span></div>
          <div class="mb-2"><b>Longitude:</b> <span id="lng">‚Äî</span></div>
          <div class="mb-2"><b>Accuracy:</b> <span id="acc">‚Äî</span> m</div>
          <div class="mb-2"><b>Last sent:</b> <span id="lastSent">‚Äî</span></div>

          <hr/>

          <h6 class="mb-2">üîó Share Link</h6>
          <div class="small-muted mb-2">‡¶è‡¶á ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ü‡¶æ Admin/Customer ‡¶ï‡ßá ‡¶¶‡¶ø‡¶® (Order ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ map ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá)‡•§</div>

          <div class="input-group">
            <input class="form-control" id="shareLink" readonly>
            <button class="btn btn-outline-primary" id="btnCopy">Copy</button>
          </div>

          <div class="small-muted mt-2">
            Viewer page will call: <code>/api/location/latest?orderId=...</code>
          </div>

          <div class="mt-3" id="msgBox"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ OrderId inject (Thymeleaf) -->
<script th:inline="javascript">
  const ORDER_ID = /*[[${orderId}]]*/ 0;
  // Viewer URL (Admin/Customer page)
  const VIEW_URL = /*[[@{/track/view}]]*/ "/track/view";
</script>

<script>
  let map, marker, watchId = null;

  const elLat = document.getElementById('lat');
  const elLng = document.getElementById('lng');
  const elAcc = document.getElementById('acc');
  const elLast = document.getElementById('lastSent');
  const elShare = document.getElementById('shareLink');
  const elMsg = document.getElementById('msgBox');

  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');

  function toast(type, text) {
    elMsg.innerHTML = `<div class="alert alert-${type} py-2 mb-0">${text}</div>`;
    setTimeout(()=> { elMsg.innerHTML = ""; }, 3500);
  }

  function fmtTime(d = new Date()) {
    return d.toLocaleString();
  }

  function setShareLink() {
    const url = new URL(window.location.origin + VIEW_URL);
    url.searchParams.set("orderId", ORDER_ID);
    elShare.value = url.toString();
  }

  async function sendLocation(lat, lng, accuracy) {
    // ‚úÖ Backend endpoint: update rider location for an order
    // You will implement this API in Spring Boot:
    // POST /api/location/update  { orderId, lat, lng, accuracy }
    try {
      const res = await fetch("/api/location/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          orderId: ORDER_ID,
          lat: lat,
          lng: lng,
          accuracy: accuracy
        })
      });

      if (!res.ok) throw new Error("HTTP " + res.status);
      elLast.textContent = fmtTime();
    } catch (e) {
      toast("danger", "‚ùå Failed to send location: " + e.message);
    }
  }

  function updateUI(lat, lng, accuracy) {
    elLat.textContent = lat.toFixed(6);
    elLng.textContent = lng.toFixed(6);
    elAcc.textContent = Math.round(accuracy);

    const pos = { lat, lng };
    if (!marker) {
      marker = new google.maps.Marker({ position: pos, map, title: "Rider" });
      map.setCenter(pos);
      map.setZoom(15);
    } else {
      marker.setPosition(pos);
      // smooth-ish follow
      map.panTo(pos);
    }
  }

  function startTracking() {
    if (!navigator.geolocation) {
      toast("warning", "Geolocation not supported on this device/browser.");
      return;
    }

    btnStart.disabled = true;
    btnStop.disabled = false;

    watchId = navigator.geolocation.watchPosition(
      async (p) => {
        const lat = p.coords.latitude;
        const lng = p.coords.longitude;
        const accuracy = p.coords.accuracy || 0;

        updateUI(lat, lng, accuracy);
        await sendLocation(lat, lng, accuracy);
      },
      (err) => {
        toast("danger", "Location error: " + err.message);
        btnStart.disabled = false;
        btnStop.disabled = true;
      },
      {
        enableHighAccuracy: true,
        maximumAge: 3000,
        timeout: 15000
      }
    );

    toast("success", "‚úÖ Tracking started");
  }

  function stopTracking() {
    if (watchId != null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    btnStart.disabled = false;
    btnStop.disabled = true;
    toast("secondary", "üõë Tracking stopped");
  }

  btnStart.addEventListener("click", startTracking);
  btnStop.addEventListener("click", stopTracking);

  document.getElementById("btnCopy").addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(elShare.value);
      toast("success", "‚úÖ Link copied!");
    } catch {
      toast("warning", "Copy failed. Please copy manually.");
    }
  });

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 23.8103, lng: 90.4125 }, // Dhaka default
      zoom: 12
    });
    setShareLink();
  }

  window.initMap = initMap;
</script>

<!-- ‚úÖ Google Maps JS API -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap">
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
